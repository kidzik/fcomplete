\documentclass[preprint]{imsart}

\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb} 
\usepackage[T1]{fontenc}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{amsthm}
\usepackage{mathtools}  
%\usepackage[OT1]{fontenc}
\usepackage{amsmath}
\usepackage[colorlinks,citecolor=blue,urlcolor=blue]{hyperref}
\usepackage[authoryear]{natbib}

\bibliographystyle{plainnat}

\startlocaldefs
\numberwithin{equation}{section}
\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newcommand{\cN}{\mathcal{N}}
\newcommand{\cS}{\mathcal{S}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\bX}{\mathbf{X}}
\newcommand{\tr}[1]{{\textcolor{red}{#1}}}
\newcommand{\tb}[1]{{\textcolor{blue}{#1}}}
\newcommand{\bt}{\mathbf{t}}
\newcommand{\by}{\mathbf{y}}
\newcommand{\bb}{\mathbf{b}}
\newcommand{\bx}{\mathbf{x}}
\newcommand{\bw}{\mathbf{w}}

\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\diag}{diag}
\DeclareMathOperator*{\rank}{rank}
\DeclareMathOperator*{\Cov}{Cov}
\DeclareMathOperator*{\Var}{Var}
\DeclareMathOperator*{\minimize}{minimize\ \ }
\DeclareMathOperator*{\subjectto}{subject\ to\ \ }
\endlocaldefs

\begin{document}

\begin{frontmatter}
\title{Longitudinal modeling\\using matrix factorization}
\runtitle{Longitudinal modeling using matrix factorization}


\begin{aug}
\author{\fnms{Trevor} \snm{Hastie}\ead[label=e1]{hastie@stanford.edu}}\thanksref{t1}
\and
\author{\fnms{\L ukasz} \snm{Kidzi\'nski}\ead[label=e2]{lukasz.kidzinski@stanford.edu}}\thanksref{t1}

\thankstext{t1}{Partially sponsored by the Mobilize Center, a National Institutes of Health Big Data to Knowledge (NIH BD2K) Center of Excellence supported through Grant U54EB020405.}
\runauthor{Trevor Hastie and {\L}ukasz Kidzi\'nski}

\affiliation{Stanford University}

\address{Department of Statistics, Stanford University\\ 
          \printead{e1}}
\address{Department of Bioengineering, Stanford University\\ 
          \printead{e2}}

\end{aug}

\begin{abstract}
  In medical research, measurements are often collected sparsely and irregularly in time while the data acquisition is expensive, inconvenient or unethical. Examples include, measurements of spine bone mineral density, cancer growth through mammography or biopsy, progression of defect of vision or assessment of gait in patients with neurological disorders. Since the data collection is often costly and inconvenient, estimation of progression from sparse observations is of great interest for practitioners.

  Such data is often analyzed in the context of a mixed-effect model where time is treated as both random and fixed effect. Alternatively, researchers analyze gaussian processes or functional data, where observations are assumed to be drawn from a certain distribution of processes. These powerful tools are flexible, but rely on a large set of probabilistic assumptions and require careful deployment.
  
  In this study we propose an alternative elementary framework for analyzing multivariate longitudinal data, relying on matrix factorization. Our method yields point estimates of progression processes by the means of iterative application of the SVD.

  
\end{abstract}

\begin{keyword}[class=MSC]
\kwd[Primary ]{62H12}
%\kwd{60K35}
\kwd[; secondary ]{62P10}
\end{keyword}

\begin{keyword}
\kwd{multivariate longitudinal data}
\kwd{functional data analysis}
\kwd{matrix factorization}
\end{keyword}

\end{frontmatter}

\maketitle

%\tableofcontents

\section{Motivation}

One of the fundamental questions in medical practice is how diseases progress in individual patients. Accurate continuous monitoring of patient's condition could considerably improve prevention and treatment. Many medical tests, such as x-ray, MRI, motion capture gait analysis, biopsy or even blood tests, are costly, harmful or inconvenient to perform frequently. Since in most situations increase in sampling is not feasible due to inconvenience and costs, practitioners need to reach out for statistical tools to analyze dynamics of these biomarkers.
% In practice, due to inherent inconvenience and costs of these exams, measurements are taken sparsely in time, tolerating potential complications between the visits.

While in many situations multiple data points from patients' histories are available, these data are often underutilized. For the sake of simplicity and convenience, many prognostic models applied in practice only use the last few observations or summary statistics such as the mean over time. However, this simplification ignores important information about the progression, including its dynamics or individual patient's variability. Moreover, the noise inherent to measurements further hinders the inference of changes in patient's health. For making use of these data, practitioners need statistical models and software. To enable appropriate usage and broad adoption, ideally, these tools should be simple to implement and understand.

%This motivates research on the longitudinal statistical analysis of progression, recovering trajectories from sparse observations. 

To illustrate potential benefits in these scenarios, in Figure \ref{fig:motivation}, we present measurements of BMI of patients with gait pathologies. The thick solid line represents the estimated mean and indicates a clear trend of growth during puberty. However, by looking at individual processes and by modeling between-subject similarities, we may expect to model the progression better, make personalized predictions, cluster patients based on their progression patterns or use the latent representation of progression patterns as a predictor in other models. 

\begin{figure}[h]
  \includegraphics[width=0.49\linewidth]{images/points}
  \includegraphics[width=0.49\linewidth]{images/grouped}
  \caption{We observe BMI of patients at every visit (left plot), and we can easily derive the population progression (thick solid curve). However, analysis of individual patients (connected dots in the right plot, also differing by color) can reveal similarities between them.}
  \label{fig:motivation}
\end{figure}

This kind of data has been commonly analyzed using linear mixed models, where we treat time as a random effect and nonlinearity of this effect is imposed by the choice of the functional basis \citep{zeger1988models, verbeke1997linear, mcculloch2001generalized}. When data is very sparse, additional constraints on covariance structure of trajectories are derived using cross-validation or information criteria \citep{rice2001nonparametric,bigelow2009bayesian}. To further reduce the dimension, practitioners model the covariance as a low-rank matrix \citep{james2000principal,berkey1983longitudinal, yan2017dynamic, hall2006properties, besse1986principal, yao2006penalized, greven2011longitudinal}. Multiple models were developed for incorporating additional covariates \citep{song2002semiparametric, liu2009joint, rizopoulos2014combining}. While these methods are implemented in practice, the nature of biomarkers differs in each clinical setting. Moreover, the probabilistic formulation of the model and dependence on underlying distributions might hinder applicability or adoption to other practical problems.

In this work, we propose an alternative elementary and flexible statistical framework, exploiting matrix factorization techniques \citep{mazumder2010spectral, hastie2015matrix, fazel2002matrix, cai2010singular}. We focus on simplicity of the formulation, and we implement software easy to use and extend. 

\section{Background and related work}\label{s:background}

In many clinical settings, researchers and practitioners model patient's history as a multivariate process of clinical measurements (such as the size of a tumor, blood markers, height and weight of a patient, etc.). The multivariate measurements are noisy, and they are observed on different time-points. This framework includes cases when, for example, clinicians perform a blood test at every visit but a biopsy sporadically. 

Even though multiple variables are measured, the ones directly related to the disease, such as the size of a tumor, are often of the special interest. Therefore, to focus our attention and aid further discussion, we start by introducing notation and methodology for the univariate case. Let $M$ denote the number of subjects. For each individual $i \in \{ 1,2,...,N \}$, we measure the process at $n_i$ irregularly sampled time-points $\mathbf{t}_i = [t_{i,1},t_{i,2},...,t_{i,n_i}]'$. Since the time interval can be easily transformed linearly, without loss of generality we assume that $t_{i,j} \in (t_{\min},t_{\max})$ for $ j \in \{1,...,n_i\}$ and some $t_{\min} < t_{\max}$.

To model the individual trajectories, given the {\it unbalanced longitudinal observations} $(\mathbf{t}_i,\mathbf{y}_i)$, practitioners map observations into a low-dimensional space which represents progression patterns. Ideally, a small distance between individuals in the latent space corresponds to a similar progression pattern.

In this section, we discuss state-of-the-art approaches to estimating this low-dimensional latent embedding. We classify them into three categories: the direct approach, mixed-effect models, and low-rank approximations. 

\subsection{Direct approach}\label{ss:direct}

If the set of observed values is dense, simple interpolation using a continuous basis can be sufficient for approximating the entire trajectory. Formally, let $\{b_i: i \in \N \}$ be a basis of $L_2([t_{\min},t_{\max}])$. In practice, we use a finite number of basis elements. Let $\bb(t) = [b_1(t),b_2(t),...,b_K(t)]'$ be a vector of $K$ basis elements evaluated at point $t \in (t_{\min},t_{\max})$. For each subject $i \in \{ 1,...,n_i \}$, we might use least squares method to find a set of coefficients $\bw_i = [w_{i,1},...,w_{i_K}]' \in \R$, minimizing euclidean distance to the observed point
\begin{align}\label{eq:direct-individual}
 \argmin_{\bw_i}\sum_{j=1}^{n_i}\left|y_{i,j} - \bw_i'\bb(t_{i,j})\right|^2.
\end{align}

It is often convenient to compute principal functional components and represent curves in the space spanned by the first few of them. This representation, referred to as a {\it Karhunen-Lo\`eve} expansion \citep{watanabe1965karhunen,kosambi2016statistics}, has became a foundation of many functional data analysis workflows \citep{ramsay1991some,yao2005linear,cnaan1997tutorial,laird1988missing,hormann2015dynamic,horvath2012inference,besse1997simultaneous}. %If measurements are dense, confidence in estimates of $\bw_i$ is high and therefore the sample covariance of $\bw_i$ might also be an accurate estimator. 

This approach to modeling the covariance structure has two main drawbacks. First, if the number of observations $n_i$ for an individual $i$ is smaller or equal to the size of the basis $K$, we can fit a curve with no error leading to overfitting and unreliable estimator of the variance. Second, this approach ignores similarities between the curves, which could potentially improve the fit.

A basic idea to remedy these issues is to estimate both the basis coefficients and the variance structure simultaneously within the framework of linear mixed-effect models.

\subsection{Linear mixed-effect models}\label{ss:lmm}

A common approach to modeling longitudinal observation $(\mathbf{t}_i, \mathbf{y}_i)$ is to assume that the data comes from a linear mixed-effect model (LMM) \citep{verbeke1997linear, zeger1988models}. We operate in a functional basis $\bb(t)$ of $K$ elements and we assume there exists a fixed effect $\mu(t) = m' \bb(t)$, where $m = [m_1,...,m_K]'$ for $m_i \in \R$. We model the individual random effect as a vector of basis coefficients. In the simplest form, we assume
\begin{align}\label{eq:latent-probabilistic}
 \mathbf{w}_i \sim \cN(0, \Sigma),
\end{align}
where $\Sigma$ is a $K \times K$ covariance matrix. We model individual observations as
\begin{align}\label{eq:probabilistic}
 \mathbf{y}_i \sim \cN(\mu_i + B_i\mathbf{w}_i, \sigma^2I_{n_i}),
\end{align}
where $\mu_i = [\mu(t_{i,1}),\mu(t_{i,2}),...,\mu(t_{i,n_i})]'$, $\sigma$ is the standard deviation of observation error and $B_i = [\bb(t_{i,1}),...,\bb(t_{i,n_i})]'$. Estimation of the model parameters is typically accomplished by the expectation-maximization (EM) algorithm \citep{laird1982random}. For estimating coefficients $\bw_i$ one can use the best unbiased linear predictor (BLUP) \citep{henderson1950estimation,robinson1991blup}. % or other techniques typical for mixed-effect models \citep{mardia1980multivariate}.

Since the LMM estimates the covariance structure and individual fit simultaneously, it reduces the problem of uncertain estimates of $\bw_i$, present in the direct approach. However, this model is only applicable if a relatively large number of observations per subject is observed since we attempt to estimate $K$ basis coefficients for every subject.

To model trajectories from a small number of observations, practitioners further constrain the covariance structure. If we knew the functions which contribute the most to the random effect, we could fit a LMM in a smaller space spanned by these functions. A solution is to learn the basis from the data, by constraining the rank of the covariance matrix or by imposing a prior on the basis parameters.

\subsection{Low-rank approximations}\label{ss:reduced-rank}

There are multiple ways to constrain the covariance structure. We can use cross-validation or information criteria to choose the best basis, the number of elements or positions of spline knots \citep{rice2001nonparametric,bigelow2009bayesian}. Alternatively we can place a prior on the covariance matrix \citep{maclehose2009nonparametric}.

Another solution is to restrict the latent space to $q < K$ dimensions and learn from the data the mapping $A \in \R^{K \times q}$ between the latent space and the basis. In the simplest scenario, observations are then modeled as
\begin{align}\label{eq:james-model}
 \mathbf{y}_i \sim \cN(\mu_i + B_i A \mathbf{w}_i, \sigma^2I_{n_i}).
\end{align}
%In this setting $\bb(t)A$
%Note that with the freedom in the choice of $A$, one can assume that $\mathbf{w}_i\ \sim\ \cN(0,I_q)$.
\citet{james2000principal} propose an EM algorithm for finding model parameters and latent variables $\bw_i$. In the expectation stage, they marginalize $\bw_i$. % given the model, i.e. $\mathbf{w}_i~=~A' B_i' (\mathbf{y}_i - \mu_i)$.
In the maximization stage, with $\bw_i$ assumed observed, they maximize the likelihood with respect to $\{\mu,A,\sigma\}$. The maximum likelihood, given $\bw_i$, takes form
\begin{align}
\prod_{i=1}^N \frac{1}{(2\pi)^{n_i/2} \sigma^{n_i} |\Sigma|^{1/2}} \exp\{ &-(\by_i' - \bw_i'\mu_i - B_i A \bw_i)'(\by_i' - \bw_i'\mu_i - B_i A \bw_i) / 2\sigma^2 \nonumber\\
&- \frac{1}{2}\bw_i' \Sigma^{-1} \bw \}.\label{eq:likelihood}
\end{align}

Another approach to estimate parameters of \eqref{eq:james-model} is to optimize over $\bw_i$ and marginalize $A$ \citep{lawrence2004gaussian}. This approach allows modifying the distance measure in the latent space, using the ``kernel trick'' \citep{schulam2016disease}.

Methods based on low-rank approximations appear to be widely adopted and applied in practice \citep{berkey1983longitudinal, yan2017dynamic, hall2006properties, besse1986principal, yao2006penalized, greven2011longitudinal}. However, due to their probabilistic formulation and reliance on the distribution assumptions, these models usually need to be fine-tuned for specific situations.

To illustrate this problem, let us assume that the data is drawn from two distributions with equal probability taking form \eqref{eq:james-model}, but with two different means: $\mu$ and $-\mu$. Then, the estimated fixed effect will be close to $0$ and the zero-mean prior distribution on the latent variables will draw these variables towards $0$.

%Linear Mixed Models \citep{zeger1988models, verbeke1997linear}
%If we assume that the processes come from the same distribution, we can use mixed effect models, treating time as a non-linear random effect \citep{}. Both methods require fairly large number of observation per individual. At the very least, we need to observe more points per subject than the size of the basis.
%Estimation of the {\it Karhunen-Lo\`eve} expansion becomes difficult when the data is sparsely observed.
%The functional principal components for sparse data, introduced by \citep{james2000principal}, is a parametric method that remedies problems of the direct approach. Similarly as in the direct approach, it imposes continuity by assuming that observations come from underlying continuous processes, however, since the dimensionality of the basis might still be too large for estimation, the model further constrains the space to just a few principal components driving the variability of observed processes.
%This leads to %Assuming a normal prior $\cN(0, \alpha I_q$ over rows of $A$, yields 
%\[ \mathbf{y}_i \sim \cN(\mu_i, \alpha \langle \mathbf{w}_i, \mathbf{w}_i \rangle B_i B_i' + \sigma^2I_{n_i}). \]
% Maximizing this expression is equivalent \citep{james2000principal} to minimizing
% \begin{align*}
% \sum_{i=1}^N \left\{ (Y_i - \alpha_iV M)'(Y_i - \alpha_iV M) + \sigma^2 \sum_{j=1}^k \frac{\alpha_{i,j}^2}{D_{jj}}\right\} =&\\
% \sum_{i=1}^N \| Y_i - \alpha_iV M\|^2 + \sigma^2 \sum_{j=1}^k \frac{1}{D_{jj}}\sum_{i=1}^N\alpha_{i,j}^2 =&\\
% \| Y - AV M\|_F^2 + \sigma^2 \| A D^{-1/2} \|_F^2,
% \end{align*}
% where $A = [\alpha_1,\alpha_2,...,\alpha_N]'$.
% Thus, the algorithm solves
% \begin{align}\label{eq:optpca}
% \argmin_{\sigma,A,V}\| Y M' - AV\|_F^2 + \sigma^2 \| A D^{-1/2} \|_F^2.
% \end{align}
% This method essentially projects $Y$ to a low-dimensional latent space. It motivates another approach, based on matrix factorization. We may consider \eqref{eq:direct} as a low-rank matrix approximation, with a constrain on $\rank{(A)}$, i.e.
% \begin{gather*}
% \text{minimize } \| P_\Omega(X - AM') \|^2,\\
% \text{subject to } \rank{(A)} \leq k,
% \end{gather*} 
% for some positive integer $k$. In Section \ref{ss:matrix-factorization} we introduce methods for solving this problem from matrix-factorization perspective. We further explore similarities between matrix factorization and sparse functional principal components in Section~\ref{s:the-link}. For details on sparse principal component analysis approach we refer the reader to \citep{james2000principal,yao2005linear, yao2005sparse}.


%\subsection{Cluster-based representation}
%\citep{marshall2000linear}.



%%%%%%%%%%%%%%%%%%%%%%%%%%

% Multiple methods were introduced for modeling trajectories underlying sparsely measured observations. If sufficient number of measurements per individual is observed, we can represent each trajectory in a smooth basis, such as splines. \citep{nickerson2013quantifying}



%Whenever multiple processes are measured, we can expect that they correlate and additional information can improve prediction of the main process of interest. We can consider this scenario as a functional regression setting with sparsely observed data \citep{hall2008modelling}. In such case, the mixed model is often chosen in practice \citep{cnaan1997tutorial,laird1988missing}. However, as in the univariate process case, it may require many observations per patient.

%%%%The rest of the article is organized as follows. In Section \ref{s:context}, our method is juxtaposed with a probabilistic approach introduced in \citep{james2000principal}.

%%%%For simplicity we assume that the population mean is known and we focus on second order properties. For methods o the mean see \citet{rice1991estimating}.

\section{Modeling sparse longitudinal processes using matrix factorization}\label{s:context}

%While low-rank mixed models, as presented in \citep{james2000principal,tipping1999probabilistic}, can be potentially extended to the regression setting, in this paper 
%[TODO: Describe the problem with existing approaches]

The mixed-effect model, as any other probabilistic model, can be heavily biased when the data comes from the distribution considerably different than assumed. Since biomarkers can differ in every clinical setting, fine-tuning the models may require time and expertise. We develop a more flexible approach to the estimation of latent variables. Our method is based solely on the $\ell_2$ approximation rather than the underlying distributions.

We pose the problem of trajectory prediction as a matrix completion problem and we solve it using sparse matrix factorization techniques \citep{rennie2005fast, candes2009exact}. In the classical matrix completion problem the objective is to predict elements of a sparsely observed matrix using its known elements, while minimizing a certain criterion, often chosen to be the Mean Squared Error (MSE). The motivating example is the ``Netflix Prize'' competition \citep{bennett2007netflix}, where participants were tasked to predict unknown movie ratings using other observed ratings. We can represent these data as a matrix of $N$ users and $M$ movies, with a subset of known elements, measured on a fixed scale, e.g. $1-5$.

One approach to solving this problem is to assume that the true matrix can be well-approximated by a low-rank matrix \citep{srebro2005generalization}. Given the low-rank representation $WA'$, columns $A$ spanning the space of movies can be interpreted as ``taste'' components and each user is represented as a weighted sum of these tastes, i.e. a row in the matrix of latent variables $W$ (see Figure \ref{fig:idea}).

We can use the same idea to predict sparsely sampled curves, as long as we introduce an additional smoothing step. The low-dimensional latent structure now corresponds to progression patterns and a trajectory of each individual can be represented as a weighted sum of these ``principal'' patterns.

%%%% The smoothness comes from the fact that in the longitudinal analysis columns of the matrix are very strongly correlated, due to continuity of the sampled processes. Conversely, as the density of the evaluation grid increases, classical matrix completion problems become more difficult, as it does not use information embedded in neighboring columns. The methodology introduced in this paper deals with this problem by projecting the observed data to a low-dimensional space of coefficients in a basis of continuous functions. In this smaller space, one can directly apply matrix completion methodology. In this scenario, dependence of the size of the grid becomes small.

\begin{figure}[h]
  \includegraphics[width=1\linewidth]{images/intro}
  \caption{This key observation motivating this paper is the fact that sparse longitudinal trajectory prediction problem can be mapped to the matrix completion problem. Matrix completion can be approached with matrix factorization where we look for $W$ and $A$ of low rank, approximating observed values in $Y$ (circled rectangles in the matrix $Y$). In the sparse longitudinal setting, we impose continuity by fixing the basis $B$ (e.g. splines) and again finding low-rank $W$ and $A$ approximating observed values in $Y$. $B$ corresponds to some discretized smooth basis, here with $3$ basis elements.}
  \label{fig:idea}
\end{figure}

We first introduce methodology for univariate sparsely-sampled processes. Next, we show that the elementary representation of the problem allows for simple extension to multivariate sparsely-sampled processes and to a regression setting.

\subsection{Notation}

%To use matrix factorization techniques, in this section we represent the data as a matrix of $N$ individuals and $T$ time-points, unlike the previous work on longitudinal modeling, presented in Section \ref{s:background}. 
%As presented in Section \ref{s:background},
%The theory of functional data analysis can be developed directly on $L_2([t_{\min},t_{\max}])$ curves or, more broadly, any separable Hilbert space \citep{ferraty2006nonparametric}. In this article
We assume that for each individual $i \in \{1,2,...,N\}$ we observe $n_i$ measurements $\{\tilde y_{i,1},...,\tilde y_{i,n_i}\}$ at time-points $\{t_{i,1},t_{i,2},...,t_{i,n_i}\}$. However, unlike the prior work introduced in Section \ref{s:background}, we discretize the time grid to $T$ equidistributed time-points $G = \left[\tau_1, \tau_2, ..., \tau_T\right],$ where $t_{\min} = \tau_1$ and $t_{\max} = \tau_T$. Each individual $i$ is expressed as a partially observed vector $r_i \in \R^T$. For each time-point $t_{i,j}$ for $1 \leq j \leq n_i$ we find a corresponding grid-point $g_i(j) = \argmin_{1 \leq k \leq T}  |\tau_k - t_{i,j}|$. We define $y_{i,g_i(j)} = \tilde y_{i,j}$. Let $O_i = \{g_i(j): 1 \leq j \leq n_i \}$ be a set of grid indices corresponding to observed grid-points for an individual $i$. All elements outside $O_i$, i.e. $\{y_{i,j} : j \notin O_i\}$ are considered missing.

We will show that in our method the grid can be arbitrarily dense with marginal compromise on performance, and therefore, without loss of generality, we assume that at most one measurement per subject is mapped to every grid-point in $G$.

In such settings, our observations can be uniquely represented as a $N \times T$ matrix $Y$ with missing values. Let $O_i = \{g_i(j): 1 \leq j \leq n_i \}$ be a set of grid indices corresponding to observed grid-points for an individual $i$. We denote the set of all observed elements by pairs of indices $\Omega = \{ (i,j) : i\in \{1,2,...,N\}, j \in O_i \}$. Let $P_\Omega(Y)$ be the projection onto observed indices, i.e. $P_\Omega(Y) = W$, such that $W_{i,j} = Y_{i,j}$ for $(i,j) \in \Omega$ and $W_{i,j} = 0$ otherwise. We will use $\|\cdot\|_F$ to denote the Frobenius norm, i.e. the square root of the sum of matrix elements, and $\|\cdot\|_*$ to denote the nuclear norm, i.e. the sum of singular values.

As in Section \ref{s:background} we impose smoothness by using a continuous basis $\bb(t) = [b_1(t),b_2(t),...,b_K(t)]'$. However, now, the basis is evaluated on the grid $G$ and we define $B = [\bb(\tau_1),\bb(\tau_2),...,\bb(\tau_T)]'$.

In our algorithms we will use a diagonal-thresholding operator defined as follows. Let $D = \diag(d_1,...,d_p)$ be a diagonal matrix. Define 
\begin{equation}
D_\lambda = \diag((d_1 - \lambda)_+,(d_2 - \lambda)_+,...,(d_p - \lambda)_+),\label{eq:thresholding}
\end{equation}
where $(x)_+ = \max(x, 0)$. 

Approaches discussed in Section \ref{s:background} can be expressed in the matrix notation. Here we discuss the direct approach and the low-rank approximation approach.
%When $T$ is sufficiently large, approaches discussed in Section \ref{s:background} can be expressed in matrix notation. %In Section [TODO] we show that from the computational standpoint $T$ can be arbitrarily large, or we can also evaluate $\bb$ at the actual observed time-points [TODO].

\subsection{Direct approach}

The optimization problem \eqref{eq:direct-individual} of the direct approach described in Section \ref{ss:direct} can be approximated in the matrix setting. First, note that the bias introduced by the grid is negligible if the grid is sufficiently large. We have
\begin{align}
  \left|\tilde y_{i,j} - \bw_i'\bb(t_{i,j})\right| &= \left|y_{i,g(j)} - \bw_i'\bb(t_{i,j})\right|\nonumber\\
  &= \left| y_{i,g(j)} - \bw_i' \bb(\tau_{g_i(j)} + t_{i,j} - \tau_{g_i(j)})\right|\nonumber\\
  &\leq \left| y_{i,g(j)} - \bw_i' \bb(\tau_{g_i(j)})\right| + \left|\bw_i' \bb(t_{i,j} - \tau_{g_i(j)})\right|\label{eq:grid-snap}
\end{align}
and by the continuity of the basis on a closed interval $[t_{\min},t_{\max}]$ the second element in \eqref{eq:grid-snap} can be arbitrarily small if $T \rightarrow \infty$. Therefore, the error of the solution of the original problem is bounded by the error of the solution the grid.

We can define the optimization problem \eqref{eq:direct-individual} mapped to the grid $G$ as a matrix completion problem
\begin{align}
 \argmin_{\{\bw_i\}}\sum_{i=1}^N \sum_{j=1}^{n_i}\left|y_{i,g_i(j)} - \bw_i' \bb(\tau_{g_i(j)}))\right|^2 &= \argmin_{\{\bw_i\}}\sum_{(i,k) \in \Omega}\left|y_{i,k} - \bw_i' \bb(\tau_{k}))\right|^2\nonumber\\
%% \end{align*}
%% or, in the matrix notation
%% \begin{align*}
&= \argmin_W \| P_\Omega(Y - WB') \|_F^2,\label{eq:direct-matrix}
\end{align}
where the optimization over $\{\bw_i\}$ is an optimization over all $\{\bw_i : i \in \{ 1,2,...,N \}\}$ and $W$ is an arbitrary $N \times K$ matrix.

The matrix formulation in equation \eqref{eq:direct-matrix} and the classic approach in Section \ref{ss:direct} share multiple characteristics. In both cases if data is dense, we may find an accurate representations of the underlying process simply by fitting least-squares estimates of $W$ or $\{\bw_i\}$. Conversely, if the data is too sparse, the problem becomes ill-posed and the least-squares estimates will overfit. Moreover, with $T \rightarrow \infty$ two frameworks become equivalent.

However, representations \eqref{eq:direct-individual} and \eqref{eq:direct-matrix} differ algebraically and this difference constitutes the foundation for the method introduced in the sequel of this paper. The matrix representation enables us to use matrix completion framework and, in particular, in Section \ref{ss:matrix-factorization} we introduce convex optimization algorithms for solving \eqref{eq:direct-matrix} with additional constraints.

Note that some low-rank constraints on the random effect from the mixed-effect model introduced in Section \ref{ss:lmm} can be expressed in terms of constraints on $W$ and they can be potentially solved without imposing probability distributions. As we show next, the linear mixed-effect model can be expressed by constraining $\rank(W)$. % for some $q \in \N$.

\subsection{Low-rank matrix approximation}\label{ss:low-rank-matrix}
In the low-rank approach described in Section \ref{ss:reduced-rank} we assume that individual trajectories can be represented in a low-dimensional space, by constraining the rank of $W$. We might attempt taking the same route, however, the problem \eqref{eq:direct-matrix} with a constraint on the rank of $W$ is a non-convex problem.

In many situations, this rank constrain can be efficiently relaxed by a nuclear norm to make the problem convex \citep{candes2009exact, fazel2002matrix}. \citet{candes2009near} consider the nuclear norm relaxation in the setting where the solution matches exactly a linear combination of the observed elements. In particular, they assume existence of exact solutions of \eqref{eq:direct-matrix} and they solve
\begin{align} 
\text{minimize\ \ } & \|W\|_*,  \nonumber\\
\text{subject to\ \ } & \| P_\Omega(Y - WB') \|_F^2 = 0.
\label{eq:cai}
\end{align}
The problem \eqref{eq:cai} can be solved using modern convex optimization software \citep{grant2008graph,boyd2004convex}, such as SDPT3 \citep{toh1999sdpt3} or SeDuMi \citep{sturm1999using}. However, with large matrices $Y$, these general algorithms can become computationally expensive and \citet{cai2010singular,mazumder2010spectral} introduced alternative iterative algorithms leveraging the low-rank and sparse decomposition.

For our application, the constraint \eqref{eq:cai} requiring exact matching of the observed and predicted values is too strong. For example, if there are more measurements per subject than $\rank(W)$ or if a subject was measured at two consecutive grid-points with some observation noise, we may not be able to find a continuous solution imposed by the smooth basis $B$. For this reason, we relax the constraint in \eqref{eq:cai} to an inequality
\begin{align}
\text{minimize\ \ } & \|W\|_*,  \nonumber\\
\text{subject to\ \ } & \| P_\Omega(Y - WB') \|_F^2 \leq \delta
\label{eq:rank-restricted}
\end{align}
for some parameter $\delta > 0$.

\citet{cai2010singular} propose a first-order singular value thresholding algorithm (SVT), solving the problem \eqref{eq:rank-restricted}. Their algorithm can handle large datasets and has strong guarantees on convergence but it requires tuning the step size parameter, which can greatly influence the performance. This limitation was addressed by \citet{ma2011fixed,mazumder2010spectral,hastie2015matrix} who introduced iterative procedures which do not depend on such tuning. Moreover, \citet{hardt2014fast,chen2015fast} propose methods for the non-convex problem and \citet{ge2016matrix} argue that the non-convex problem has no spurious local minima.

In the last decade, the machine learning and statistical learning communities have introduced multiple algorithms for matrix completion. Many of them are suitable for solving \eqref{eq:rank-restricted}. However, in this article we focus on analyzing benefits of framing the trajectory prediction problem \eqref{eq:direct-individual} in the matrix completion framework, rather than on benchmarking existing solutions.

We argue that the matrix formulation \eqref{eq:rank-restricted} has two key advantages over the probabilistic approach (Section \ref{ss:reduced-rank}). First, the problem \eqref{eq:rank-restricted} does not impose any assumption on the distribution of $W$ or on the distribution of the noise. This property is particularly important whenever the data does not follow normal distribution. We further describe links between the matrix factorization and low-rank mixed-effect models in Section~\ref{s:the-link}. Second, the elementary formulation of \eqref{eq:rank-restricted} allows us to generalize this model to the multivariate or regression setting as we discuss in Section \ref{s:multivariate}.  

%In Section \ref{ss:matrix-factorization} we introduce methods for solving a relaxed version of this problem. % 

% Estimation of the {\it Karhunen-Lo\`eve} expansion becomes difficult when the data is sparsely observed.
% The functional principal components for sparse data, introduced by \citep{james2000principal}, is a parametric method that remedies problems of the direct approach. Similarly as in direct approach, it imposes continuity by assuming that observations come from underlying continuous processes, however, since the dimensionality of the basis might still be too large for estimation, the model further constrains the space to just a few principal components driving the variability of observed processes.

% In this model, partially observed curves $Y_i$ for $i \in \{1,2,...,N\}$ are assumed to come from a distribution
% \[
% Y_i \sim \cN(\mu, M \Sigma M' + \Gamma),
% \]
% where $I_T$ is an identity matrix, $\Sigma$ can be approximated by a low-rank matrix and $\Gamma_{T\times T}$ represents covariance of the noise. For the illustration of the idea, we assume $\Gamma = \sigma^2 I_T$, with some $\sigma > 0$ and an identity matrix $I_T$. By the spectral theorem, we decompose $\Sigma$ to $\Sigma = V \Lambda V'$ with a diagonal matrix $D$ and orthogonal $V$. We rewrite distribution of $Y_i$ as
% \begin{equation}\label{eq:probabilistic-model}
% Y_i \sim \cN(\mu, M V \Lambda V' M' + \sigma I_T),
% \end{equation}
% and we use maximum likelihood method to estimate $\sigma, V, \Lambda$. We are maximizing
% \[
% \prod_{i=1}^N \frac{1}{(2\pi)^{T/2} |M V \Lambda V' M' + \sigma^2I_T|^{1/2}} \exp\left\{ -(Y_i)'(M V \Lambda V'M' + \sigma^2 I_T )^{-1} (Y_i) / 2\right\}.
% \]
% Assume that we know the latent scores $\alpha_i$ and we need to find the projection space. Then the likelihood can be written as
% \[
% \prod_{i=1}^N \frac{1}{(2\pi)^{T/2} \sigma^T |\Lambda|^{1/2}} \exp\left\{ -(Y_i' - \alpha_i' V' M')'(Y_i' - \alpha_i' V' M') / 2\sigma^2 - \frac{1}{2}\alpha_i' \Lambda^{-1} \alpha_i \right\}.
% \]
% \citet{james2000principal} introduced an algorithm for estimating the mean $\mu$ and finding $(\alpha_i)$ and $(\sigma, V)$ iteratively by Expectation-Maximization (EM).
% % Maximizing this expression is equivalent \citep{james2000principal} to minimizing
% % \begin{align*}
% % \sum_{i=1}^N \left\{ (Y_i - \alpha_iV M)'(Y_i - \alpha_iV M) + \sigma^2 \sum_{j=1}^k \frac{\alpha_{i,j}^2}{D_{jj}}\right\} =&\\
% % \sum_{i=1}^N \| Y_i - \alpha_iV M\|^2 + \sigma^2 \sum_{j=1}^k \frac{1}{D_{jj}}\sum_{i=1}^N\alpha_{i,j}^2 =&\\
% % \| Y - AV M\|_F^2 + \sigma^2 \| A D^{-1/2} \|_F^2,
% % \end{align*}
% % where $A = [\alpha_1,\alpha_2,...,\alpha_N]'$.
% % Thus, the algorithm solves
% % \begin{align}\label{eq:optpca}
% % \argmin_{\sigma,A,V}\| Y M' - AV\|_F^2 + \sigma^2 \| A D^{-1/2} \|_F^2.
% % \end{align}

\subsection{Low-rank approximation with singular value thresholding}\label{ss:matrix-factorization}

The low-rank probabilistic approach, introduced in Section \ref{ss:reduced-rank}, is based on the observation that the underlying processes for each subject can be approximated in a low-dimensional space. %In $P_\Omega(Y)$, it is only feasible to estimate a low-rank representation of $Y$ matrix. %\citet{fazel2002matrix} show that, in order to make the optimization problem convex, the low-rank constraint \eqref{eq:rank-restricted} might be relaxed to a constraint on the nuclear norm of a matrix.
Here, we exploit the same characteristic using a matrix-factorization techniques for solving the optimization problem \eqref{eq:rank-restricted}.

Note, that in the Lagrangian form, the problem \eqref{eq:rank-restricted} becomes
%\begin{align}\label{eq:mazumder}
%\min_{\tilde{W}} \frac{1}{2} \|P_\Omega(Y - \tilde{W})\|_F^2 + \lambda\|\tilde{W}\|_*,
%\end{align}
%for some $\lambda = \lambda(\sigma) \geq 0$ and $\tilde{W}$ is a $N \times T$ matrix. \citet{hastie2015matrix} introduced a fast and parallel algorithm for solving \eqref{eq:mazumder}.
% In our longitudinal setting, estimating $\tilde{W}$ directly from \eqref{eq:mazumder} will fail since it does not account for the continuous structure. Instead, we further constrain \eqref{eq:mazumder} by imposing the continuous basis $B$. We optimize
\begin{align}\label{eq:matrixproblem-final}
\min_Z \frac{1}{2} \|P_\Omega(Y - WB')\|_F^2 + \lambda\|W\|_*,
\end{align}
for some $\lambda > 0$ and where $W$ is an $N \times K$ matrix. For the sake of clarity and simplicity, we choose to solve the problem \eqref{eq:matrixproblem-final} with an extend version of the \textsc{Soft-Impute} algorithm designed by \citet{mazumder2010spectral}. As discussed in Section \ref{ss:low-rank-matrix}, many other convex optimization algorithms can be applied.

The key component to the solution is the following property linking the problem \eqref{eq:matrixproblem-final} with singular value decomposition (SVD). Consider the fully observed case of \eqref{eq:matrixproblem-final}. Using Theorem 2.1 in \citet{cai2010singular}, one can show that the optimization problem
\begin{align}\label{eq:optsvd}
\argmin_{W} \frac{1}{2} \| Y - WB' \|_F^2 + \lambda\|W\|_*
\end{align}
has a unique solution $W = \cS_\lambda (YB)$, where $\cS_\lambda(X) = UD_\lambda V'$ and $X = UDV'$ is the SVD of $X$. We refer to this $\cS_\lambda(X)$ as a singular value thresholding (SVT) of $X$.

% \section{Longitudinal impute algorithms}
In order to solve \eqref{eq:optsvd} with a sparsely observed  $Y$, we modify the \textsc{Soft-Impute} algorithm from \citep{mazumder2010spectral} to account for the basis $B$. Our Algorithm \ref{alg:soft-impute} iteratively constructs better approximations of the global solution for each $\lambda$ in some predefined set $\{\lambda_1, \lambda_2, ..., \lambda_k\}$. Suppose we have some approximation of the solution $W^{old}$. We impute $W^{old}B$ to unknown elements of $Y$ obtaining $\tilde{Y}$. We construct the next approximation $W^{new}$ by computing SVT of $\tilde{Y}$.

%In Appendix \ref{s:convergence} we show that $W^{new,k}$ converges to the global solution $W_\lambda$ of \eqref{eq:matrixproblem-final}.
As our stopping criterion we compute the change between subsequent solution, relative to the magnitude of the solution, following the methodology in \cite{cai2010singular}. We set some fixed threshold for this value, e.g. $\varepsilon = 10^{-4}$.

\begin{algorithm}
\caption{\textsc{Soft-Longitudinal-Impute}\label{alg:soft-impute}}
\begin{enumerate}
\item Initialize $W^{old}$ with zeros
\item Do for $\lambda_1 > \lambda_2 > ... > \lambda_k$:
\begin{enumerate}
\item Repeat:
\begin{enumerate}
\item Compute $W^{new} \leftarrow S_{\lambda_k}( (P_\Omega(Y) + P_\Omega^\perp(W^{old}B'))B )$.
\item If $\frac{\|W^{new} - W^{old}\|_F^2}{\|W^{old}\|_F^2} < \varepsilon$ exit.
\item Assign $W^{old} \leftarrow W^{new}$
\end{enumerate}
\item Assign $\hat{W}_{\lambda_k} \leftarrow W^{new}$
\end{enumerate}
\item Output $\hat{W}_{\lambda_1}, \hat{W}_{\lambda_2}, ... , \hat{W}_{\lambda_k}$.
\end{enumerate}
\end{algorithm}

The common bottleneck of algorithms introduced by \citet{cai2010singular,mazumder2010spectral,ma2011fixed} as well as other SVT-based approaches is the computation of the SVD of large matrices. This is particularly severe in typical matrix completion settings, such as the Netflix problem, where the matrix size is over $400{,}000 \times 20{,}000$. However, in our problem,
\begin{align}\label{eq:small-rank}
  \rank(WB') \leq \rank(B) = K \ll N,
\end{align}
with $K \sim 10$ in our motivating data example. While algorithms for large matrices are also applicable here, the property \eqref{eq:small-rank} makes the computation of SVD feasible in practice with generic packages such as PROPACK \citep{larsen2004propack}.

\paragraph{Modeling new data.}

For modeling new data, in practice, we are interested in two scenarios: (1) we collect a new measurements of an existing patient $i \in \{1,2,...,N\}$; (2) we observe a new patient $(N+1)$. In both cases, we simply use the current fit for each parameter $\lambda$ and update all models with newly observed data. This approach not only estimates new predictions but also slightly improves the existing model. 

%\tr{[TODO] If $n_i < q$, where $q$ is the rank of the current model, we might impose some additional conditions on $U_i$ and/or shrink it}

% \paragraph{Convergence.}

% Convergence of the algorithm can be proven by an elementary extension of the proofs in \citet{mazumder2010spectral}. We demonstrate a formal mapping of our problem to their setting Appendix \ref{s:convergence}.

\subsection{$\ell_0$-norm regularization}

While the nuclear norm relaxation \eqref{eq:rank-restricted} is motivated by making the problem convex, \citet{mazumder2010spectral} argue that in many cases it can also give better results than the rank constraint. They draw an analogy to the relation between best-subset regression ($\ell_0$ regularization) and LASSO ($\ell_1$ regularization \citep{tibshirani1996regression, friedman2001elements}). In LASSO by shrinking model parameters we allow more parameters to be included, what can potentially improve the prediction if the true subset is larger than the one derived through $\ell_0$ regularization. In the case of \eqref{eq:matrixproblem-final}, shrinking the nuclear norm allows to include more dimensions of $W$ again potentially improving the prediction if the true dimension is high.

%While the nuclear norm normalization is motivated by the convex relaxation of the rank, \citet{mazumder2010spectral} observe that in many cases it can outperform rank restricted least squares. Analogically to \textsc{Lasso}, shrinkage can allow a rank higher than the actual rank of the matrix, improving prediction.

Conversely, the same phenomenon can also lead to problems if the underlying dimension is small. In such case, shrinking may allow including unnecessary dimensions emerging from noise. To remedy this issue, following the analogy with penalized linear regression, we may consider another classes of penalties. In particular, we may consider coming back to the rank constraint by modifying the nuclear norm penalty \eqref{eq:matrixproblem-final} to $\ell_0$. We define $\|W\|_0 = \rank(W)$. For solving
\begin{align}\label{eq:matrixproblem-final-l0}
\min_{W} \frac{1}{2} \|P_\Omega(Y - WB')\|_F^2 + \lambda\|W\|_0,
\end{align}
we use Algorithm \ref{alg:hard-impute}. % refering to \citet{mazumder2010spectral}. %Multiple extensions and analogies to regularization in linear models can be drawn in this setting. See \citep{mazumder2010spectral} for more details on possible extensions of the problem \eqref{eq:rank-restricted}.

\begin{algorithm}
\caption{\textsc{Hard-Longitudinal-Impute}\label{alg:hard-impute}}
\begin{enumerate}
\item Initialize $W^{old}_{\lambda_i}$ with solutions $\tilde{W}_{\lambda_i}$ from \textsc{Soft-Longitudinal-Impute}
\item Do for $\lambda_1 > \lambda_2 > ... > \lambda_k$:
\begin{enumerate}
\item Repeat:
\begin{enumerate}
\item Compute $W^{new} \leftarrow S_{\lambda_k}^H( (P_\Omega(Y) + P_\Omega^\perp(W^{old}M'))M )$.
\item If $\frac{\|W^{new} - W^{old}\|_F^2}{\|W^{old}\|_F^2} < \varepsilon$ exit.
\item Assign $W^{old} \leftarrow W^{new}$
\end{enumerate}
\item Assign $\hat{W}_{\lambda_k} \leftarrow W^{new}$
\end{enumerate}
\item Output $\hat{W}_{\lambda_1}, \hat{W}_{\lambda_2}, ... , \hat{W}_{\lambda_k}$.
\end{enumerate}
\end{algorithm}

The problem \eqref{eq:matrixproblem-final-l0} is non-convex, however, by starting from the solutions of Algorithm \ref{alg:soft-impute} we explore the space around the global minimum of the $\ell_1$ version of the problem. This strategy has been shown successful empirically \citep{ge2016matrix}.

% and in recent years there has been a growing interest in analyzing properties of non-convex algorithms for matrix completion \cite{sun2016guaranteed}.

\subsection{The link between reduced-rank model and \textsc{Soft-Longitudinal-Impute}}\label{s:the-link}

%Let $L < K$ be a number of true factors and let $\Tau_{L\times K}$ be a matrix of $L$ factor loadings in the basis $M_{K\times T}$.

Intuitively we might expect similarity between the principal directions derived using the probabilistic approach \eqref{eq:probabilistic} and their counterparts derived from the SVT-based approach. We investigate this relation by analyzing solutions given by SVT for matrices sampled from the probabilistic model.

For simplicity, we start with the case where the mean $\mu = 0$ and the data is fully observed on a grid $G$ of $T$ time-points. Assume that observations $i \in \{1,2,...,N\}$ come from the mixed-effect model
\begin{align}
  \by_i &\sim \cN(\bw_i B', \sigma^2 I_T), \label{eq:model-y}\\
  \bw_i &\sim \cN(0 , \Sigma), \label{eq:model-w}
\end{align}
% V \Lambda V'
%
where $\Sigma$ is a covariance matrix of rank $q < K$ and variables $\{\bw_i, \by_i\}$ are uncorrelated. By the spectral decomposition theorem we write $\Sigma = V\Lambda V'$, where $V$ is a $K\times K$ orthogonal and $\Lambda$ is a diagonal $K\times K$ matrix with $q$ positive coefficients in decreasing order.
Since $\by_i$ and $\bw_i$ are uncorrelated, the distribution \eqref{eq:model-y} can be rewritten as
\begin{align}
  \by_i &\sim \cN(0, B V \Lambda V'  B' + \sigma^2 I_T). \label{eq:model}
\end{align}
Note that, the model \eqref{eq:model} is a factor model with $q$ factors--the first $q$ columns of $BV$.

The following theorem constitutes a link between the mixed-effect model and SVT. It is adapted from Theorem 9.4.1 in \citet{mardia1980multivariate}, derived from \citet{joreskog1967some}, 

\begin{theorem}\label{thm:maxlike}
  Let $Y = [\by_1,...,\by_N]'$ be the observed matrix and let $S_{\sigma^2}(YB) = UD_{\sigma^2}Q'$. Then, $(D_{\sigma^2},Q)$ is the maximum likelihood estimator of $(\Lambda,V)$.
\end{theorem}

 %One approach to estimate parameters in \eqref{eq:model-y} is to first decompose $YB = U D W'$ using SVD. ,
Factor analysis provides us not only with estimates of $\Lambda$ and $V$ but also with estimates of the individual latent variables $W = [\bw_1,...,\bw_N]'$.
%% For a fixed $\sigma$, the likelihood wrt. $(\lambda,V)$ is maximized by
%% \[
%%  \Lambda = D_{\sigma^2} \text{ and } V = Q,
%% \]
%% where $D_\sigma$ is the thresholded $D$ as defined in \eqref{eq:thresholding}.
In multivariate analysis literature, there are multiple ways to estimate factor scores, i.e. a matrix $A$ such that $X \sim AD_{\sigma^2}V'$, most notably Spearman's scores, Bartlett's scores and Thompson's scores \citep{kim1978factor}. %\citet{james2000principal} find maximum likelihood estimates for all parameters together.
Simply taking $W = U$ as the estimate of the scores corresponds to the solution of \eqref{eq:optsvd} as long as $\lambda = \sigma^2$.

Note that in Theorem \ref{thm:maxlike} we assume that $\sigma^2$ is known, which is unfeasible in practice. However, the likelihood of $(V,\sigma)$ can be parametrized by $\sigma$ and we can find the optimal solution analytically. This corresponds to minimizing \eqref{eq:optsvd} for different $\lambda$.

%In the sparsely observed case, we want to approximate the same 
%\tr{TODO} }

This intuition is also confirmed in our simulation study in Section \ref{s:simulation} (see Figure \ref{fig:principal-components}). Note that a similar analogy is drawn between the classical principal component analysis and probabilistic principal component analysis by \citet{tipping1999probabilistic} and \citet{james2000principal}. 

% Bartlett's estimate of the scores is
% \[
% U' = (\Theta' \Psi^{-1} \Theta)^{-1} \Theta'\Psi^{-1} X',
% \]
% where in our case $\Psi = \sigma^2 I$. thus
% \begin{align*}
% U' &= (\Theta' \sigma^{-2} I \Theta)^{-1} \Theta'\sigma^{-2} I X'\\
% &= (D_{\sigma^2}^{1/2}V' \sigma^{-2} VD_{\sigma^2}^{1/2})^{-1} D_{\sigma^2}^{1/2}V' \sigma^{-2} X'\\
% &= \sigma^{2}(D_{\sigma^2}^{1/2} D_{\sigma^2}^{1/2})^{-1} D_{\sigma^2}^{1/2}V' \sigma^{-2} X'\\
% &= (D_{\sigma^2})^{-1/2}V' X'.
% \end{align*}
% Bartlett's factor score is an unbiased estimator of factor scores.

% This method decomposes $Y$ to
% \begin{align*}
% X \sim U D_{\sigma^2}^{1/2} V',
% \end{align*}
% so, if we define $\tilde{U} = U D^{-1/2}$, we have
% \begin{align*}
% X \sim \tilde{U} D^{1/2}D_{\sigma^2}^{1/2} V',
% \end{align*}
% which implies that the factor model solves \eqref{eq:optsvd} with $\lambda = \sigma^2$.

% \paragraph{Thompson's factor scores}
% Thompson's estimate of the scores is
% \[
% U' = (I + \Theta' \Psi^{-1} \Theta)^{-1} \Theta'\Psi^{-1} Y',
% \]
% which gives
% \begin{align*}
% U' &= (I + D_{\sigma^2})^{-1} D_{\sigma^2}^{1/2}V' Y'
% \end{align*}

% It gives more accurate predictions \citet{paterek2007improving}.

% \citet{krzanowski1995multivariate} and \citet{tipping1999probabilistic} show that
% \[
% \sigma_{ML}^2 = \frac{1}{p-q} \sum_{i = p-q+1}^d\lambda_i.
% \]
% Other references: \citet{rubin1982algorithms}.



% \subsection{Factor analysis (PC)}

% We initially 'guess' an estimator for $\sigma$, say $\hat\sigma_1$ in \eqref{model:x}. We decompose $S~-~\hat\sigma_1^2I_d~=~\hat\Theta_1 \hat\Theta_1'$. We estimate $\sigma$ and estimate $\hat\Theta_2$. We iterate and converge to $\hat\Theta$. See \citet{lawley1971factor}.

% \subsection{Factor analysis (centroid method)}
%  \citet{lawley1971factor}

%\subsection{Tresholded SVD}
%Let $X_1,X_2,...,X_n$ be observations from \eqref{model:x}. Let $\bX = [X_1',X_2',...,X_n']'$. Consider


\section{Multivariate sparse longitudinal modeling}\label{s:multivariate}

One major advantage of the matrix-factorization approach is its simple algebraic formulation and solution which makes it easily adaptable to more complex situations. In this section, we present methods for expanding our methodology to a process of variables of interest measured sparsely in time. We explore two cases: (1) dimensionality reduction, where we project sparsely sampled multivariate processes to small latent spaces, and (2) linear regression, where multivariate processes are used for prediction of another process of interest.

Both cases are directly motivated by medical applications where multiple clinical tests are taken sparsely in time. The dimensionality reduction allows to compare subjects with each other in a smaller space, independent of the sampling time of the orginal processes. The regression setting allows to use additional covariates in estimation of the progression of the main parameter of interest. To motivate both cases from the theorethical standpoint we start with a bivariate process.

\subsection{Motivation: Bivariate processes}

Suppose we partly observe $N\times T$ matrices $X$, $Y$ and we aim at regressing $Y$ on $X$. Let $B$ be a $T\times K$ matrix of $K$ splines evaluated on a grid $G$ of $T$ timepoints. We assume the model \begin{align*}
X = \tilde{X}B' + E_X \text{ \ and \ } Y = \tilde{Y}B' + E_{Y},
\end{align*}
where $\tilde{X}$ is a $N\times K$ matrix, $E_X$ and $E_Y$ are $N \times T$ matrices with independent identically distributed coordinates $\cN(0,\sigma_X^2)$ and $\cN(0,\sigma_Y^2)$ correspondingly, $\tilde{Y}~=~\tilde{X}A$ for some $K\times K$ matrix $A$. We assume $\rank(\tilde{X}) = k$, where $k < K$.

We consider the optimization problem
%Now, in order to estimate the low-rank decomposition of $Y$ we consider %the problem \eqref{eq:rank-restricted} to
\begin{align}\label{eq:lag:bivariate}
  \minimize_{A,\tilde{X}} & \frac{1}{\sigma_Y^2} \| Y - \tilde{X}AB' \|_F^2 + \frac{1}{\sigma_X^2}\|X - \tilde{X}B' \|_F^2,\nonumber\\
  \subjectto & \rank(\tilde{X}) = k.
\end{align}
Let $\gamma = \sigma_X^2 / \sigma_Y^2$. Then \eqref{eq:lag:bivariate} can be written as
\begin{align}\label{eq:lag:bivariate2}
  \minimize_{A,\tilde{X}} & \| (Y:\gamma X) - \tilde{X}(AB':\gamma B') \|_F^2,\nonumber\\
  \subjectto & \rank(\tilde{X}) = k,
\end{align}
which we solve by computing the SVD of $(YB:\gamma XB)$. 

Note that solving the problem \eqref{eq:lag:bivariate} is equivalent to finding the first $k$ principal directions in the canonical correlation analysis (CCA) \citep{hotelling1936relations}. Moreover, if $\gamma=1$ the problem is equivalent to partial least squares (PLS) \citep{wold1975soft}. Solutions of CCA and PLS can be derived from the SVD of $(YB:\gamma XB)$ \citep{borga1997unified}.

Although we motivate the problem \eqref{eq:lag:bivariate2} as a regression of $Y$ on $X$, there is symmetry between the two variables. The solution $\tilde{X}$ can be interpreted a latent representation of the two processes. To emphasize this, we introduce the latent $N \times K$ matrix $U$ and we rewrite the problem as
\begin{align}\label{eq:lag:bivariate2}
  \minimize_{U,A_X,A_Y} & \| (Y:\gamma X) - U(A_YB':A_XB') \|_F^2,\nonumber\\
  \subjectto & \rank(U) = k.
\end{align}
As in \eqref{eq:rank-restricted} the rank constrain can be relaxed to the nuclear norm. Then, Lagrangian takes form
\begin{align}
  \argmin_{U,A_X,A_Y} \| (Y:\gamma X) - U(A_YB':A_XB') \|_F^2 + \lambda \| U \|_*  \label{eq:final-bivariate}
\end{align}
and methodology from Section \ref{ss:matrix-factorization} applies.

The low-rank matrix $U$ is a joint low-rank representation of matrices $X$ and $Y$ and can be seen as a dimensionality reduction technique. In Section \ref{ss:dim-red} we extended this method to a larger number of variables. It can be also used for regression, as discussed in Section \ref{ss:regression}.

Note that the approach presented in this section has an intuitive analogy in matrix completion problem. \citet{condli1999bayesian} proposed a Bayesian framework and showed that for improving prediction of entries in $Y$ one might consider a low-rank decomposition of $(Y:X)$, where $X$ are additional covariates for each individual (each row), e.g. demographic features.

%% Using SVD any solution can be written as $(\hat{X} : \hat{Y}) = U (V_X'M' : V_Y'M')$. Now let $\hat{X} = UV_X'M'$ and $\hat{Y} = UV_Y'M'$. 
%% The problem \eqref{eq:two-vars} can be becomes
%% \begin{align*}
%% \argmin_{U,V_X,V_Y} \frac{1}{2} \| XM - U V_X' \|_F^2 + \frac{1}{2} \| YM - U V_Y' \|_F^2 + \lambda\|U\|_*,
%% \end{align*}
%% which is equivalent to
%% \begin{align}\label{eq:final-bivar}
%% \argmin_{U,V_X,V_Y} \frac{1}{2} \| (XM:YM) - U (V_X:V_Y)' \|_F^2 + \lambda\|U\|_*.
%% \end{align}
%% where $(\cdot:\cdot)$ operator is concatenation of matrices column-wise. This can be solved using direct extension of Algorithm \ref{alg:soft-impute}.

\subsection{Dimensionality reduction}\label{ss:dim-red}

Suppose that for every individual we observe multiple variables varying in time, e.g. results of multiple medical tests at different times in a clinic, and we want to find a projection on $\R^d$ maximizing the variance explained for some $d \in \N$. %For fully observed $X_1,...,X_p$ this would correspond to the reduced-rank SVD of concatenated matrices $X_1~:~X_2~:~...~:~X_p$. %In this section, we introduce a method for finding such projection when the data is sparsely observed. We illustrate the method on bivariate processes, however it can be easily extended to any $p$-dimensional processes. 

We extend the equation \eqref{eq:final-bivariate} to account for a larger number of covariates
\begin{align*}%\label{eq:multivar}
\argmin_{U,V} &\| (X_1:X_2:...:X_p) - U (A_1B_1':A_2B_2':...:A_pB_p') \|_F^2 + \lambda\|U\|_*,
\end{align*}
where $B_{i}$ is basis selected for approximation of processes $X_{i}$ for $1 \leq i \leq p$. 

Note that by allowing a different basis for each process, we also allow for covariates constant in time if $X_i$ is a $N\times 1$ matrix and $B_{(i)} = 1$ for some $1 \leq i \leq p$.
Finally, if measurements are on different scales, we may normalize them using any scaling $\gamma_1, \gamma_2,..., \gamma_p > 0$, and taking
\begin{align*}%\label{eq:multivar-scaled}
\argmin_{U,V} &\| (\gamma_1 X_{1}:\gamma_2 X_{2}:...:\gamma_p X_{p}) - U (A_1B_1':A_2B_2':...:A_pB_p') \|_F^2 + \lambda\|U\|_*.
\end{align*}
See Algorithm \ref{alg:soft-PCA} for the detailed description of the procedure. Note that \textsc{Hard-Longitudinal-Impute} can be analogically extended to the multivariate setting. %Similarly, the proof of convergence follows from the proof in Section \ref{s:convergence}.

\begin{algorithm}
\caption{\textsc{Soft-Longitudinal-PCA}\label{alg:soft-PCA}}
\begin{enumerate}
\item Normalize $X_1,...,X_p$ (optional)
\item Initialize $W^{old}_1,...,W^{old}_p$ with zeros
\item Do for $\lambda_1 > \lambda_2 > ... > \lambda_k$:
\begin{enumerate}
\item Repeat:
\begin{enumerate}
\item Compute $W^{prj}_i = (P_\Omega(X_i) + P_\Omega^\perp(W_i^{old}M'))M$ for $i \in \{1,...,p\}$,
\item Compute $W^{new} \leftarrow S_{\lambda_k}( W^{prj}_1 : ... : W^{prj}_p )$.
\item If $\frac{\|W^{new} - W^{old}\|_F^2}{\|W^{old}\|_F^2} < \varepsilon$ exit.
\item Assign $W^{old} \leftarrow W^{new}$
\end{enumerate}
\item Assign $\hat{W}_{\lambda_k} \leftarrow W^{new}$
\end{enumerate}
\item Output $\hat{W}_{\lambda_1}, \hat{W}_{\lambda_2}, ... , \hat{W}_{\lambda_k}$.
\end{enumerate}
\end{algorithm}

\subsection{Regression}\label{ss:regression}

In practice we may be interested in estimating progression of a certain parameter (e.g. cancer growth) given progressions of other covariates such as blood tests, vitals, biopsy results, etc.

The method proposed in Section \ref{ss:dim-red} can be directly applied for finding relation between the processes. However, it might be suboptimal for prediction of a single parameter of choice, as it optimizes for least-squares distance in all variables rather than only the dependent variable. This is analogical to the difference between regression line of $Y$ on independent variables $X_1,...,X_p$ and the first principal component analysis of $(Y,X_1,...,X_p)$, used for prediction of $Y$. While the first one minimizes the distance to $Y$, the latter minimizes the distance to $(Y,X_1,...,X_p)$. Instead, for the regression problem we suggest a two step procedure motivated by principal component regression. 

% using the method from Section \ref{ss:dim-red} as a basis for the principal component regression.

In our two-step procedure, we first find a joint low-rank decomposition $U$ of covariates $X_1,...,X_p$ and then regress $Y$ on $U$. Note that the latent representation $U$ can be constructed either by applying sparse functional PCA, by \textsc{Soft-Longitudinal-Impute}, jointly by \textsc{Soft-Longitudinal-PCA} or by other low-rank representation of $(X_1,...,X_p)$.

% Let $U$ be a latent representation of $X_1, X_2, ..., X_p$, derived using one of the aformentioned methods.
Let $U_{d}$ denote the first $d$ columns of $U$. We find a $d \times K$ matrix $A$ such that
\begin{align}\label{eq:pcr}
\minimize_A \|P_\Omega(Y - U_dAB')\|_F^2,
\end{align}
where $P_\Omega$ is a projection on a set of observed coefficients.

We propose an iterative algorithm where we fill in the missing values in $Y$ with zeros, multiply the exprssion by $B$, regress $YB$ on $U_dA$, and use the new $A$ for filling in the missing values, till convergence. We refer to Algorithm \ref{alg:sparse-regression} for the full description of the procedure.


%% Note that $B$ can be estimated by minimizing 
%% \begin{align}\label{eq:regression:minimization}
%% \argmin_B \|P_\Omega((U'U)^{-1}U'Y - BM')\|_F^2,
%% \end{align}

%% \tr{TODO: How it works. Regularization. References.\\
%% It should be very simple to show that Algorithm \ref{alg:sparse-regression} defines a contraction operator with the fixed-point equal to the solution of \eqref{eq:regression:minimization}. \citep{bertsekas1999nonlinear}
%% }


\begin{algorithm}
\caption{\textsc{Sparse-Longitudinal-Regression}\label{alg:sparse-regression}}
\vspace{3pt}
\begin{flushleft}
\textbf{Step 1: Latent representation}
\end{flushleft}
\begin{enumerate}
\item For sparsely observed $X_1,X_2,...,X_p$ find latent representations $U_1,U_2,...,U_p$
\item Define $U = U_1:U_2:...:U_p$
\item Orthogonalize $U$
\end{enumerate}
\begin{flushleft}
\textbf{Step 2: Regression}
\end{flushleft}
\begin{enumerate}
\item Initialize $A$ with Gaussian noise
\item Repeat till convergence:
\begin{enumerate}
\item Impute regressed values $\hat{Y} = P_\Omega(Y) + P_\Omega^\perp(UAB')$
\item Compute $A^{new} \leftarrow U'\hat{Y}B$
\item If $\frac{\|A^{new} - A\|_F^2}{\|A\|_F^2} < \varepsilon$ exit
\item Assign $A \leftarrow A^{new}$
\end{enumerate}
\item Return $A$
\end{enumerate}
\end{algorithm}


\section{Simulations}\label{s:simulation}

We illustrate properties of the multivariate longitudinal fitting in a simulation study. Let $G$ be a grid of $T = 51$ equidistributed points and let $B$ be a basis of $K = 9$ functions evaluated on the grid $G$. We generate observations from the model $\eqref{eq:model}$ with $p \in \{3,5,7\}$ true components. %We set $V\Lambda V'$ to a matrix with eigenvalues $\diag[1-\frac{1}{7},...,1 - \frac{p}{8},0,...,0]$.

We draw two matrices $X_1,X_2$ of size $N \times K$ from this distribution and we define $Y = R_1 X_1 + R_2 X_2$, where $R_1,R_2$ are some fixed rotations in $\R^K$. We observe $Y_f = YB' + 2* E_Y, X_{1,f} = X_1B' + E_{X_1}$ and $X_{2,f} = X_2 B' + E_{X_2}$, where $E_{X_1},E_{X_2},E_{Y}$ are matrices with uncorrelated Gaussian coordinates with standard deviation $\sigma = 0.2$. We observe $10\%$ of indices. Our objective is to estimate $Y$ using the observed data.

We compare Sparse-Longitudinal-Impute with the results from the fPCA \citep{james2000principal}, implemented in \citet{peng2009geometric}. Both, Sparse-Longitudinal-Impute and fPCA require a parameter corresponding to the number of basis elements $k$. In our method we also need the tuning parameter $\lambda$, whilst in fPCA we need to chose the rank $R$. We use cross-validation to find $(k_{ours},\lambda)$ and $(k_{FPCA},R)$.

For illustration, we also present results of Sparse-Longitudinal-Regression (SLR), regressing $Y$ on $X_1$ and $X_2$. Note, however that the SLR, unlike two other methods, uses additional information about $Y$. The comparison is only meant to illustrate potential gain in this setting.

We compare the three methods fPCA, SLI and SLR, in reference to the baseline -- the {\it estimated subject's mean}. For each subject $p$ we compute the {\it estimated subject's mean} by taking the mean $\hat{m}_p$ of observed elements in $P_\Omega(X)$ in the row $p$. We assign $P_\Omega(\hat{X})_p = P_\Omega(X)_p$ and $P^\perp_\Omega (\hat{X}_p) \equiv \hat{m}_p$, where $P(\cdot)_p$ denotes the $p$-th row of the projection.

We divide the observed coefficients into training ($81\%$), validation ($9\%$) and test ($10\%$) sets. We choose the best parameters of the three models on the validation set and then retrain on the entire training + validation set. Finally, since in the simulated setting we have access to the ground truth, we compare algorithms on the entire curves. We compute the error of entire curves by taking mean squared Frobenius distance between $Y$ and estimated $\hat{Y}$, i.e.
\[
 \verb|err|(\hat{Y}) = \frac{1}{nT} \sum_{i=1}^N \|Y_i - \hat{Y}_i \|_F^2.
 \]
 
\paragraph{Results}

Our SLI achieves performance similar to \citep{james2000principal}, as presented in Table \ref{tbl:simulations}. The SLR, having access to additional information about $Y$, clearly outperforms other methods validating its correctness.

In Figure \ref{fig:principal-components} we present the first components derived from both sparse functional PCA and Soft-Longitudinal-Impute. In Figure \ref{fig:example-predictions} we present example predictions from all four methods. In Figure \ref{fig:estimated-rank}, we present the estimated rank and cross-validation error of one of the simulation runs.

% latex table generated in R 3.4.1 by xtable 1.8-2 package
% Tue Aug 29 21:46:47 2017
\begin{table}[ht]
\centering
\begin{tabular}{rrr}
  \hline
 & MSE & \% expl \\ 
  \hline
  mean & 3.43 & 0.00 \\ 
  fpca & 2.00 & 39.18 \\ 
  SLI & 1.99 & 40.20 \\ 
  SLR & 1.26 & 61.34 \\ 
   \hline
\end{tabular}\label{tbl:simulations}
\caption{Average (across 10 trials) variance explained by (1) mean: subject's mean of observed points, (2) fpca, (3) SLI: Sparse-Longitudinal-Impute and (4) SLR: Sparse-Longitudinal-Regression (with additional data available).}
\end{table}

\begin{figure}[h!]
  \includegraphics[width=1\linewidth]{images/components}
  \caption{The first three principal components derived using sparse functional PCA (left) and Soft-Longitudinal-Impute (right). The components are ordered as follow: 1st black solid curve, 2nd red dashed curve, 3rd green dotted line. The shape of components is similar while they differ by scale, since SFI does not normalize them.}
  \label{fig:principal-components}
\end{figure}

\begin{figure}[h!]
  \includegraphics[width=1\linewidth]{images/predictions}
  \caption{Two example curves (black and red) for each of the four methods. Solid lines are the true curves and dashed lines are the predictions. }
  \label{fig:example-predictions}
\end{figure}

\begin{figure}[h!]
  \includegraphics[width=1\linewidth]{images/cross-val}
  \caption{Estimated error of the solution (left) and the estimated rank of the solution (right) depending on the parameter $\lambda$.}
  \label{fig:estimated-rank}
\end{figure}


% \begin{figure}[h!]
%   \includegraphics[width=0.47\linewidth]{images/ours-smpl}
%   \includegraphics[width=0.47\linewidth]{images/fpca-smpl}\\
%   \includegraphics[width=0.47\linewidth]{images/ours}
%   \includegraphics[width=0.47\linewidth]{images/fpca}
%   \caption{Top: noisy samples, Bottom: real curves, Left: ours, Right: fPCA}
%   \label{fig:basis}
% \end{figure}

\section{Data study}

The target class of problems motivating this study is prediction of trajectory of disease progression from sparse observations. As an example application, we analyze a dataset of Gillette Children's Hospital patients visiting the clinic between 1994 and 2014, mostly diagnosed with Cerebral Palsy (CP), age ranging between 4 and 19 years. The dataset contains $84$ visits of $36$ patients without gait disorders and $6066$ visits of $2898$ patients with gait pathologies. 

One popular quantitative characteristic of gait patterns is a so-called Gait Deviation Index (GDI) introduced by \citet{schwartz2008gait}. During each visit of a child in a clinic, their body kinematics are recorded using motion capture technology. GDI, which is a function of these measurements, was collected along with patient's age and other parameters irrelevant for the purpose of this paper.

We are interested in predicting patient's GDI development trajectory based solely on their GDI history and histories of other patients. A good model of progression trajectories can constitute an important baseline for analyzing effects of treatments -- accurate prediction of a trajectory can help us understand if an improvement after a therapy is meaningful or if it is only a result of natural progression.

We randomly selected $10\%$ of observations from patients who visited the clinic at least $4$ times as our test set. Then, we split the remaining $90\%$ of observations into a training and validation sets. We train the algorithms with all combinations of parameters $K \in \{6,8,10\}$, $\lambda \in \{0.5, 0.75, 1, 1.5, 2\}$ and $R \in \{2,3,4\}$.

Let us denote the validation set as $S \subset \{1,2,...,N\} \times \{1,2,...,T\}$. We validate each model $M$, by computing the mean squared error, i.e.
\[
\verb|MSE|(M) = \|P_S(M(X) - X)\|_2^2.
\]
We select the parameters using cross-validation. We estimate errors by cross-validation, sampling $95\%$ of points to train the models and leaving $5\%$ for estimating the \verb|MSE|. We test $4$ methods for prediction: sparse functional principal components (\verb|fPCA|), \textsc{Soft-Longitudinal-Impute} (\verb|SLI|) and \textsc{Soft-Longitudinal-Regression} (\verb|SLR|) and subject's mean (\verb|mean|). In the regression setting, we approximate GDI by using its own latent as well as latent variables of the patient's O2 expenditure and their BMI.

% latex table generated in R 3.4.1 by xtable 1.8-2 package
% Tue Sep  5 22:27:27 2017
\begin{table}[ht]
\centering
\begin{tabular}{rrr}
  \hline
 & mean & sd \\ 
  \hline
regression & 128.34 & \textbf{11.95} \\ 
  impute & \textbf{128.31} & 12.47 \\ 
  fPCA & 129.01 & 12.47 \\ 
  mean & 144.31 & 12.83 \\ 
   \hline
\end{tabular}\label{tbl:data-res}
\caption{Distribution of cross-validated MSE of the four procedures: sparse functional principal components (fPCA), Soft-Longitudinal-Impute (SLI), Soft-Longitudinal-Regression (SLR), subjects mean (mean). Top characteristic in bold.}
\end{table}

\begin{figure}[h]
  \includegraphics[width=0.7\linewidth]{images/cv-data-err}
  \caption{Distribution of cross-validated MSE of the four procedures: sparse functional principal components (fPCA), Soft-Longitudinal-Impute (SLI), Soft-Longitudinal-Regression (SLR), subjects mean (mean).}
  \label{fig:Boxplots}
\end{figure}

All three methods reduce the \verb|MSE| by $\sim 10\%$. We present detailed results in Table \ref{tbl:data-res} and in Figure \ref{fig:Boxplots}. 


% \section{Simulations}

% We take the grid of size $d = 51$ and a spline basis of $9$ functions (Figure \ref{fig:basis}). We generate observations from model $\eqref{eq:model}$ with $k = 9$ true components. We set $\Theta\Theta'$ to be a matrix with eigenvalues $\diag[1,0.9,0.5,e^{-3},...,e^{-8}]$. We observed values with uncorrelated gaussian noise with $\sigma^2 = 0.25$. The matrix is fully-observed.

% In functional PCA we run the procedure with different $K = 1,2,...,9$ and in Soft-Impute we run the estimation procedure with different $\lambda$. We present the best results in Figure \ref{fig:results}. We analyze two errors: mean squared distance (1) from the observed points ($M_O$) and (2) from the true processes ($M_T$). For now, no cross-validation -- only in-sample fit.

% Preliminary results are presented in (Table \ref{tab:results}).
% \begin{table}[h]
%   \centering
% \begin{tabular}{lcc}
%                   & $M_O$ & $M_T$\\
% \hline
% Soft-Impute  & 0.91 (sd=0.006) & 0.97 (sd=0.07)\\ 
% Sparse fPCA & 0.93 (sd=0.009) & 0.91 (sd=0.07)\\
% \end{tabular}
%   \caption{Results from only ten trials (TODO).}\label{tab:results}
% \end{table}

% Results from one of the simulations are presented in Figure \ref{fig:results}. In Figure \ref{fig:components} we plot components and in Figure \ref{fig:scores} we plot scores.

% \begin{figure}[h]
%   \includegraphics[width=\linewidth]{images/simulation-results}
%   \caption{5 example curves. True processes (top-left), Observed processes (top-right). Soft-impute estimates (bottom-left) and sparse functional PCA estimates (bottom-right).}
%   \label{fig:results}
% \end{figure}

% \begin{figure}[h]
%   \includegraphics[width=\linewidth]{images/simulation-components}
%   \caption{Components}
%   \label{fig:components}
% \end{figure}

% \begin{figure}[h]
%   \includegraphics[width=\linewidth]{images/simulation-scores}
%   \caption{Scores}
%   \label{fig:scores}
% \end{figure}

% \section{Other applications}
% Some other cases where the structure can be available.
% \begin{enumerate}
% \item Images?
% \item General applications of low-rank methods: clustering
% \end{enumerate}

% \section{Discussion}

\bibliographystyle{imsart-nameyear}
\bibliography{report}

%% \appendix

%% \section{\tr{TODO: Convergence Analysis}}\label{s:convergence}

%% We prove convergence by mapping our problem into the framework of \citet{mazumder2010spectral}. First we redefine the observed values by defining the operators
%% \[
%% P_{\Omega,M}(X) = P_\Omega(X)M \text{ and } P_{\Omega,M}^\perp(X) = P_\Omega^\perp(X)M
%% \]
%% Note that $P_{\Omega,M}$ is not a projection, but it shares some properties, required for directly applying proofs from \citep{mazumder2010spectral}. In particular, 
%% $P_{\Omega,M}(X) + P_{\Omega,M}^\perp(X) = XM$ and
%% \begin{equation}
%% 	\|P_{\Omega,M}(X) + P_{\Omega,M}^\perp(X)\|_F^2 = \|P_{\Omega,M}(X)\|_F^2 + \|P_{\Omega,M}^\perp(X)\|_F^2.
%% \end{equation} We define
%% \begin{align}\label{eq:helper-function}
%%  f_\lambda(W) := \frac{1}{2} \|P_{\Omega,M}(X) - P_{\Omega,M}(WM')\|_F^2 + \lambda\|W\|_*.
%% \end{align}
%% Our objective is to find $ Z_\lambda = {\arg\min}_Z f_\lambda(W)$. We define
%% \[
%% Q_\lambda(W|\tilde{W}) = \frac{1}{2}\|P_{\Omega,M}(X) + P_{\Omega,M}^{\perp}(\tilde{W} M') - Z\|_F^2 + \lambda \|W\|_*,
%% \]
%% as a surrogate of $f_\lambda$. One can show that Algorithm \ref{alg:soft-impute} in the step $k$ computes $W_\lambda^{k+1} = \argmin_Z Q_\lambda(W|W_\lambda^k)$.

%% The key ingredients of the proof of convergence are the following two lemmas,
%% \begin{lemma}
%% Suppose the matrix $W_{N \times T}$ has rank $r \leq K$. The solution to the optimization problem
%% \begin{equation}\label{eq:lemma1}
%% \min_Z \frac{1}{2}\|WM - Z \|_F^2 + \lambda\|W\|_*
%% \end{equation}
%% is given by $\hat{W} = S_\lambda(WM)$ where
%% \[
%% S_\lambda(WM) \equiv UD_\lambda V' \text{ with } D_\lambda = \diag[(d_1 - \lambda)_+, ..., (d_r - \lambda)_+],
%% \]
%% $UDV'$ is the SVD of $WM$, $D = \diag[d_1,...,d_r]$, and $t_+ = \max(t,0)$.
%% \end{lemma}
%% \begin{proof}
%% % Note that for any $A_{N\times T}$ of rank $K$, we have $S_\lambda(AM') = S_\lambda(A)M'$ and since \eqref{eq:lemma1} is equivalent to
%% % \[
%% % \min_Z \frac{1}{2}\|WM - Z \|_F^2 + \lambda\|W\|_*,
%% % \]
%% The proof follows from Lemma 1 from \citep{mazumder2010spectral}. %, and $\hat{W} = S_\lambda(WM) = S_\lambda(W)M$.
%% % Similarly, we can show that the sequence 
%% % \begin{equation}\label{eq:sequence}
%% % Z_\lambda^{k+1}M' = S_\lambda(P_\Omega(X) - P_\Omega(W_\lambda^k M')),
%% % \end{equation}
%% % defined in Algorithm \ref{alg:soft-impute}, converges to the solution of \eqref{eq:matrixproblem-final}. 
%% \end{proof}
%% \begin{lemma}\label{eq:z-sequence}
%% For every fixed $\lambda \geq 0$, define a sequence $W_\lambda^k$ by
%% \[
%% Z_\lambda^{k+1} = \argmin_Z Q_\lambda(W|W_\lambda^k)
%% \]
%% with any starting point $W_\lambda^0$. The sequence $W_\lambda^k$ satisfies 
%% \[
%% f_\lambda(W_\lambda^{k+1}) \leq  Q_\lambda(W_\lambda^{k+1} | Z_\lambda^k ) \leq f_\lambda(W_\lambda^{k})
%% \]
%% \end{lemma}
%% \begin{proof}
%% Thanks to properties of $P_{\Omega,M}(X)$, the proof follows from Lemma 2 from \citep{mazumder2010spectral}.
%% \end{proof}
%% Similarly, thanks to equivalent properties of $P_\Omega$ and $P_{\Omega,M}$, we get equivalent results for Lemmas 3-6 from \citep{mazumder2010spectral}. This also allows implies the main result
%% \begin{theorem}
%% The sequence of $W_{\lambda}^k$ defined in Lemma \ref{eq:z-sequence} converges to a limit $W_\lambda^\infty$ that solves
%% \[
%% \min_Z \frac{1}{2} \|P_{\Omega,M}(X) - P_{\Omega,M}(WM')\|_F^2 + \lambda\|W\|_*,
%% \]
%% \end{theorem}

%% \begin{proof}
%% It's sufficient to show that $W_{\lambda}^k$ has a limit. Then, the convergence follows from Lemma 5 in \citep{mazumder2010spectral}.

%% Now
%% \begin{align*}
%% \|W_\lambda - Z_\lambda^k\|_F^2 &= \|S_\lambda((P_{\Omega,M}(X) + P_{\Omega,M}^\perp(W_\lambda M'))M) - S_\lambda((P_{\Omega,M}(X) + P_{\Omega,M}^\perp(W_\lambda^{k-1}M'))M)\|_F^2 \\
%% &\leq \|(P_{\Omega,M}(X) + P_{\Omega,M}^\perp(W_\lambda M'))M - (P_{\Omega,M}(X) + P_{\Omega,M}^\perp(W_\lambda^{k-1}M'))M\|_F^2\\
%% &= \|P_{\Omega,M}^\perp(W_\lambda M') - P_{\Omega,M}^\perp(W_\lambda^{k-1}M')\|_F^2\\
%% &= \|P_{\Omega,M}^\perp(W_\lambda M' - Z_\lambda^{k-1}M')\|_F^2\\
%% &\leq \|W_\lambda - Z_\lambda^{k-1}\|_F^2
%% \end{align*}
%% and the reminder of the proof follows from the proof of Theorem 1 in \citep{mazumder2010spectral}.
%% \end{proof}

%% \section{\texttt{fimpute} package}

%% Let \verb|data| be the data matrix with columns \verb|subjectID, time, gdi, weight, dmc|, with $2-10$ observations for each \verb|subjectID|. Package \verb|fimpute| enables performing three tasks:
%% \begin{enumerate}
%% \item imputing missing values in \verb|gdi|,
%% \item projecting patients on a 2D plane using entire trajectories,
%% \item imputing missing values in \verb|gdi| using variables \verb|weight, dmc|.
%% \end{enumerate}
%% Each of these methods is embedded in the \verb|fregression(formula, data)| function, where the \verb|formula| can take one of the following forms, mimicking \verb|nlme| package:
%% \begin{enumerate}
%% \item \verb@gdi:time ~ 1 | subjectID@ for \textsc{Soft-Longitudinal-Impute},
%% \item \verb@gdi:1 ~ time + weight + dmc | subjectID@ for dimensionality reduction,
%% \item \verb@gdi:time ~ weight + dmc | subjectID@ for regression. 
%% \end{enumerate}

\end{document}
